[ {
  "defaultTab" : "nodes",
  "description" : "Automate Documentation Generation\n[![GenAI Documentation](https://img.shields.io/badge/GenAI%20Documentation-green)](https://img.shields.io/badge/GenAI%20Documentation-green)\n\n# AI Job Documenter\n\n\n> Take the headache out of Rundeck Job Documentation\n\n## Overview\nThe AI Job Documenter automates the process of generating and updating documentation for Rundeck jobs by leveraging Python scripts and OpenAI APIs. It retrieves job definitions from a Rundeck server, generates updated documentation, and updates the job descriptions. Additionally, it can upload the generated documentation to Confluence, streamlining the documentation workflow for enterprise environments.\n\n## Job Metadata\n| Property            | Value   |\n|---------------------|---------|\n| **Group**           | AI      |\n| **Execution Enabled** | true   |\n| **Schedule Enabled** | true   |\n| **Multiple Executions** | true |\n| **Log Level**       | INFO    |\n\n## Parameters\n| Parameter           | Type   | Required | Default                       | Sensitive | Description                                                                 |\n|---------------------|--------|----------|-------------------------------|-----------|-----------------------------------------------------------------------------|\n| `JOB_ID`            | String | ✓        | N/A                           |           | Enter your Job UUID (Long Alphanumeric). Required if not uploading to Confluence. |\n| `OPENAI_TOKEN`      | String | ✓        | N/A                           | ✓         | Enter your OpenAI token (Or token for your local LLM).                      |\n| `API_TOKEN`         | String | ✓        | N/A                           | ✓         | Authentication token for Runbook Automation.                                |\n| `RUNBOOK_SERVER`    | String | ✓        | http://oracle.local:4440      |           | Full URL of the Runbook Automation Server.                                  |\n| `CONFLUENCE`        | Choice | ✓        | No                            |           | Option to upload the documentation to Confluence. Choices: Yes, No.         |\n| `CONFLUENCE_LOCATION` | String | ✓      | YOUR CONFLUENCE URL           |           | Confluence server URL.                                                      |\n| `CONFLUENCE_USER`   | String | ✓        | youruser@company.com          |           | Username for Confluence authentication.                                     |\n| `CONFLUENCE_TOKEN`  | String | ✓        | 1234                          |           | Token for Confluence authentication.                                        |\n| `CONFLUENCE_SPACEKEY` | String | ✓      | CD                            |           | Your Confluence Space ID, e.g., CD.                                         |\n| `OPENAI_MODEL`      | Choice | ✓        | gpt-4o                        |           | Choose an OpenAI model. Options: gpt-3.5-turbo-16k, gpt-4-turbo, gpt-4o.    |\n\n## Workflow Steps\n\n### Step 1: Update Documentation/Confluence\n- **Type**: script\n- **Runtime**: python\n- **Description**: This step executes a Python script to update documentation and optionally publish it to Confluence.\n- **Key Operations**:\n  - Fetches job definition from Rundeck using the Rundeck API.\n  - Generates documentation using OpenAI's API.\n  - Updates the job definition in Rundeck with the generated documentation.\n  - Optionally publishes the documentation to Confluence if enabled.\n\n## Prerequisites\n| Requirement                                    | Evidence                                |\n|------------------------------------------------|-----------------------------------------|\n| Python environment with `requests` and `openai` libraries installed | Code imports these libraries.           |\n| Network access to the Rundeck server           | Uses `requests` to call Rundeck API.    |\n| Valid OpenAI API token                         | Referenced in the script configuration. |\n| Authentication tokens for Rundeck and Confluence | Referenced in the script configuration. |\n\n---\n\n**Disclaimer:** This document and the described automation job are provided \"as is\" without warranty of any kind, express or implied. The user assumes all risks associated with the use of this job. The creators or contributors are not liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement of substitute goods or services; loss of use, data, or profits; or business interruption) caused and on any theory of liability, whether in contract, strict liability, or tort (including negligence or otherwise) arising in any way out of the use of this job, even if advised of the possibility of such damage.",
  "executionEnabled" : true,
  "group" : "AI",
  "id" : "f6975c35-c075-4098-94c1-9c692b4698cb",
  "loglevel" : "INFO",
  "maxMultipleExecutions" : "5",
  "multipleExecutions" : true,
  "name" : "AI Job Documenter (OpenAI Version)",
  "nodeFilterEditable" : false,
  "options" : [ {
    "description" : "The Rundeck Job UUID to generate documentation for. This is the long alphanumeric identifier found in the job URL or job definition. Required when not uploading to Confluence.",
    "label" : "Enter Job Unique ID (UUID)",
    "name" : "JOB_ID",
    "type" : "text"
  }, {
    "description" : "API key for OpenAI or a compatible local LLM endpoint. Used to generate documentation content via the chat completions API. Stored securely in Key Storage.",
    "hidden" : true,
    "label" : "OpenAI API Token",
    "name" : "OPENAI_TOKEN",
    "secure" : true,
    "storagePath" : "keys/project/Catalog/openai_key",
    "type" : "text",
    "valueExposed" : true
  }, {
    "description" : "Authentication token for the Rundeck / Runbook Automation API. Used to fetch job definitions and push updated descriptions. Stored securely in Key Storage.",
    "hidden" : true,
    "label" : "API TOKEN",
    "name" : "API_TOKEN",
    "secure" : true,
    "storagePath" : "keys/project/Catalog/local_api_key",
    "type" : "text",
    "valueExposed" : true
  }, {
    "description" : "Full URL of the Rundeck or Runbook Automation server, including protocol and port. Example: https://server.runbook.pagerduty.cloud",
    "hidden" : true,
    "label" : "RBA Server",
    "name" : "RUNBOOK_SERVER",
    "type" : "text",
    "value" : "http://oracle.local:4440"
  }, {
    "description" : "Whether to publish the generated documentation to a Confluence space. When set to 'Yes', the job will create a new Confluence page with the documentation content.",
    "enforced" : true,
    "hidden" : true,
    "label" : "Upload to Confluence?",
    "name" : "CONFLUENCE",
    "required" : true,
    "value" : "No",
    "values" : [ "Yes", "No" ],
    "valuesListDelimiter" : ","
  }, {
    "description" : "Base URL of the Confluence server, including protocol. Example: https://yourcompany.atlassian.net",
    "hidden" : true,
    "label" : "Confluence Server",
    "name" : "CONFLUENCE_LOCATION",
    "value" : "YOUR CONFLUENCE URL"
  }, {
    "description" : "Username or email address for Confluence API authentication. Typically the email associated with your Atlassian account.",
    "hidden" : true,
    "label" : "Confluence Username",
    "name" : "CONFLUENCE_USER",
    "value" : "youruser@company.com"
  }, {
    "description" : "API token for Confluence authentication. Generate this from your Atlassian account settings under API Tokens.",
    "hidden" : true,
    "label" : "Confluence Token",
    "name" : "CONFLUENCE_TOKEN",
    "value" : "1234"
  }, {
    "description" : "The Confluence Space key where documentation pages will be created. This is the short identifier visible in your space URL. Example: CD",
    "hidden" : true,
    "label" : "Confluence Space",
    "name" : "CONFLUENCE_SPACEKEY",
    "required" : true,
    "value" : "CD"
  }, {
    "description" : "The OpenAI model to use for documentation generation. Larger models produce higher quality output but cost more per request. gpt-4o is recommended for best results.",
    "enforced" : true,
    "hidden" : true,
    "label" : "OpenAI Model",
    "name" : "OPENAI_MODEL",
    "value" : "gpt-4o",
    "values" : [ "gpt-3.5-turbo-16k", "gpt-4-turbo", "gpt-4o" ],
    "valuesListDelimiter" : ","
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "args" : "1",
      "autoSecureInput" : "false",
      "description" : "Update Documentation/Confluence",
      "fileExtension" : ".py",
      "interpreterArgsQuoted" : false,
      "passSecureInput" : "false",
      "script" : "# MIT License\n# Copyright (c) 2023\n# Permission is hereby granted, free of charge, to any person obtaining a copy\n# of this software and associated documentation files (the \"Software\"), to deal\n# in the Software without restriction, including without limitation the rights\n# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n# copies of the Software, and to permit persons to whom the Software is\n# furnished to do so, subject to the following conditions:\n#\n# The above copyright notice and this permission notice shall be included in\n# all copies or substantial portions of the Software.\n#\n# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n# SOFTWARE.\n\nimport sys\nimport json\nimport logging\nimport requests\nimport markdown\nfrom openai import OpenAI\n\n# ---------------------------------------------------------------------------\n# Logging\n# ---------------------------------------------------------------------------\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s [%(levelname)s] %(message)s\",\n    handlers=[logging.StreamHandler(sys.stdout)],\n)\nlog = logging.getLogger(__name__)\n\n# ---------------------------------------------------------------------------\n# Configuration (Rundeck option variable substitution)\n# ---------------------------------------------------------------------------\nCONFIG = {\n    \"rundeck_url\": \"@option.RUNBOOK_SERVER@\",\n    \"auth_token\": \"@option.API_TOKEN@\",\n    \"job_id\": \"@option.JOB_ID@\",\n    \"openai_model\": \"@option.OPENAI_MODEL@\",\n    \"openai_api_key\": \"@unquotedoption.OPENAI_TOKEN@\",\n    \"confluence_enabled\": \"@option.CONFLUENCE@\",\n    \"confluence_url\": \"@option.CONFLUENCE_LOCATION@//wiki/rest/api/content\",\n    \"confluence_user\": \"@option.CONFLUENCE_USER@\",\n    \"confluence_key\": \"@option.CONFLUENCE_KEY@\",\n    \"confluence_space_key\": \"@option.CONFLUENCE_SPACEKEY@\",\n}\n\nRUNDECK_HEADERS = {\n    \"X-Rundeck-Auth-Token\": CONFIG[\"auth_token\"],\n    \"Accept\": \"application/json\",\n    \"Content-Type\": \"application/json\",\n}\n\n# ---------------------------------------------------------------------------\n# Prompt Engineering - System + User separation\n# ---------------------------------------------------------------------------\n\nSYSTEM_PROMPT = \"\"\"You are a technical documentation specialist for Rundeck / Runbook Automation jobs.\n\nYour role is to analyse Rundeck job definition JSON and produce precise, professional Markdown documentation.\n\n## Critical Rules\n\n1. **Only document what exists in the JSON.** Never invent, assume, or hallucinate values.\n   - If a field isn't present in the JSON, omit the row or section entirely.\n   - Never guess authors, versions, runtimes, or timeout values unless explicitly defined.\n   - If there are no notifications defined, omit the Notifications section completely.\n   - If there are no error handlers defined, omit the Exit Codes section completely.\n\n2. **Analyse every workflow step thoroughly.**\n   - Read each step's `script`, `scriptInterpreter`, `exec`, `jobref`, or `pluginType`.\n   - Identify the language/runtime (bash, python, powershell, ansible, etc.).\n   - Describe what the step actually does in plain technical English.\n   - Call out any external API calls, file operations, or service interactions.\n\n3. **Extract parameters accurately from the `options` array.**\n   - Map `name`, `type`, `required`, `value` (default), and `description`.\n   - If an option has `valuesUrl`, note that values are dynamically loaded.\n   - If an option has `values`, list the allowed choices.\n   - Options with `secure: true` or `valueExposed: false` should be marked as sensitive.\n\n4. **Identify prerequisites by reading the actual code**, not by guessing.\n   - CLI tools used (curl, jq, aws, kubectl, etc.)\n   - Network endpoints called\n   - Environment variables referenced (especially @option. and @globals.)\n   - Required permissions or credentials\n\n5. **Format output as clean Markdown only.** No preamble, no sign-off, no commentary outside the document. Start with the badge, end with the disclaimer.\"\"\"\n\nUSER_PROMPT_TEMPLATE = \"\"\"Analyse the following Rundeck job definition JSON and generate documentation following this structure.\n\n**Only include sections where you have real data from the JSON. Skip any section where you would need to guess or use placeholder values.**\n\n---\n\nRequired structure (include badge first):\n\n[![GenAI Documentation](https://img.shields.io/badge/GenAI%20Documentation-green)](https://img.shields.io/badge/GenAI%20Documentation-green)\n\n# [Job Name from JSON]\n\n> [One line: what this job does, 10-15 words max]\n\n## Overview\n[2-3 sentences. What does this job do? What business problem does it solve? What systems does it interact with? Base this entirely on the workflow steps and options.]\n\n## Job Metadata\n| Property | Value |\n|----------|-------|\n[Only include rows where the value exists in the JSON. Possible rows:]\n[**Group** if `group` is defined]\n[**Schedule** if `schedule` is defined - describe the cron expression in human terms]\n[**Execution Enabled** from `executionEnabled`]\n[**Schedule Enabled** from `scheduleEnabled`]\n[**Multiple Executions** from `multipleExecutions` if present]\n[**Node Filter** if `nodefilters` is defined - describe the targeting]\n[**Timeout** only if `timeout` is explicitly set]\n[**Retry** only if `retry` is explicitly set]\n[**Log Level** if `loglevel` is defined]\n\n## Parameters\n| Parameter | Type | Required | Default | Sensitive | Description |\n|-----------|------|----------|---------|-----------|-------------|\n[One row per option. Mark secure options. Note dynamic value sources.]\n\n## Workflow Steps\n[For each step in the sequence:]\n### Step N: [Brief title based on what it does]\n- **Type**: [script / command / job reference / plugin / etc.]\n- **Runtime**: [bash / python / powershell / etc. if applicable]\n- **Description**: [What this step actually does, based on reading the code]\n- **Key Operations**: [Bullet list of significant actions: API calls, file writes, conditionals, etc.]\n[If the step has error handlers, note them here.]\n\n## Prerequisites\n| Requirement | Evidence |\n|-------------|----------|\n[Only list things you can actually identify from the code/config:]\n[CLI tools used in scripts]\n[Network endpoints or APIs called]\n[Authentication tokens or credentials referenced]\n[Specific node requirements from nodefilters]\n\n## Notifications\n[ONLY include if `notification` block exists in the JSON]\n| Event | Type | Target |\n|-------|------|--------|\n[Map from onsuccess/onfailure/onstart notification configs]\n\n## Error Handling\n[ONLY include if error handlers are defined in workflow steps]\n[Describe the error handling strategy: keepgoing vs. fail, step-level handlers, etc.]\n\n---\n\n**Disclaimer:** This document and the described automation job are provided \"as is\" without warranty of any kind, express or implied. The user assumes all risks associated with the use of this job. The creators or contributors are not liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement of substitute goods or services; loss of use, data, or profits; or business interruption) caused and on any theory of liability, whether in contract, strict liability, or tort (including negligence or otherwise) arising in any way out of the use of this job, even if advised of the possibility of such damage.\n\n---\n\n**Job Definition JSON:**\n\n```json\n{json_payload}\n```\"\"\"\n\n# ---------------------------------------------------------------------------\n# Rundeck API functions\n# ---------------------------------------------------------------------------\n\ndef get_job_definition(job_id: str) -> list:\n    \"\"\"Fetch the full job definition from Rundeck API.\"\"\"\n    endpoint = f\"{CONFIG['rundeck_url']}/api/44/job/{job_id}\"\n    response = requests.get(endpoint, headers=RUNDECK_HEADERS, timeout=30)\n    response.raise_for_status()\n    return response.json()\n\n\ndef get_project_info(job_id: str) -> tuple[str, str]:\n    \"\"\"Get project name and URL for a given job ID.\"\"\"\n    endpoint = f\"{CONFIG['rundeck_url']}/api/44/job/{job_id}/info\"\n    response = requests.get(endpoint, headers=RUNDECK_HEADERS, timeout=30)\n    response.raise_for_status()\n    data = response.json()\n    return data.get(\"project\"), data.get(\"href\")\n\n\ndef update_job_definition(job_definition: list, project_name: str) -> None:\n    \"\"\"Import the modified job definition back into Rundeck.\"\"\"\n    endpoint = (\n        f\"{CONFIG['rundeck_url']}/api/47/project/{project_name}\"\n        f\"/jobs/import?dupeOption=update&format=json\"\n    )\n    response = requests.post(\n        endpoint, json=job_definition, headers=RUNDECK_HEADERS, timeout=60\n    )\n    response.raise_for_status()\n    log.info(\"Job definition updated successfully.\")\n\n\n# ---------------------------------------------------------------------------\n# OpenAI documentation generation\n# ---------------------------------------------------------------------------\n\ndef generate_documentation(job_json: list, model: str) -> str:\n    \"\"\"Send job definition to OpenAI and get back Markdown documentation.\"\"\"\n    client = OpenAI(api_key=CONFIG[\"openai_api_key\"])\n\n    # Pretty-print the JSON for better model comprehension\n    json_payload = json.dumps(job_json, indent=2, default=str)\n\n    user_prompt = USER_PROMPT_TEMPLATE.format(json_payload=json_payload)\n\n    response = client.chat.completions.create(\n        model=model,\n        messages=[\n            {\"role\": \"system\", \"content\": SYSTEM_PROMPT},\n            {\"role\": \"user\", \"content\": user_prompt},\n        ],\n        temperature=0.3,  # Lower temp for more consistent, factual output\n        max_tokens=4096,  # Increased for complex jobs with many steps\n    )\n\n    if not response.choices:\n        raise RuntimeError(\"OpenAI returned no choices in the response.\")\n\n    content = response.choices[0].message.content\n    if not content or not content.strip():\n        raise RuntimeError(\"OpenAI returned empty documentation content.\")\n\n    return content.strip()\n\n\n# ---------------------------------------------------------------------------\n# Post-processing\n# ---------------------------------------------------------------------------\n\ndef clean_markdown(raw: str) -> str:\n    \"\"\"Strip common LLM artifacts from generated markdown.\"\"\"\n    cleaned = raw\n    # Remove markdown code fences if the model wrapped the whole response\n    if cleaned.startswith(\"```markdown\"):\n        cleaned = cleaned[len(\"```markdown\") :]\n    if cleaned.startswith(\"```\"):\n        cleaned = cleaned[3:]\n    if cleaned.endswith(\"```\"):\n        cleaned = cleaned[:-3]\n    return cleaned.strip()\n\n\ndef apply_docs_to_job(job_definition: list, docs: str) -> list:\n    \"\"\"Set the generated documentation as the job's description field.\"\"\"\n    formatted = \"\\n\" + docs.replace(\"\\\\n\", \"\\n\")\n    job_definition[0][\"description\"] = formatted\n    return job_definition\n\n\n# ---------------------------------------------------------------------------\n# Confluence publishing\n# ---------------------------------------------------------------------------\n\ndef build_confluence_prefix(\n    project_name: str, job_definition: list, job_id: str\n) -> str:\n    \"\"\"Build a metadata table to prepend to the Confluence page.\"\"\"\n    job = job_definition[0]\n    project_url = (\n        f\"{CONFIG['rundeck_url']}/project/{project_name}/job/show/{job_id}\"\n    )\n    return f\"\"\"\n# Information\n\n| Field              | Value |\n|--------------------|-------|\n| Project Name       | {project_name} |\n| Job Name           | {job.get('name', 'Unknown')} |\n| Job ID             | {job_id} |\n| Execution Enabled  | {job.get('executionEnabled', 'N/A')} |\n| Schedule Enabled   | {job.get('scheduleEnabled', 'N/A')} |\n| URL                | [{project_url}]({project_url}) |\n\n---\n\"\"\"\n\n\ndef convert_markdown_to_html(md_content: str) -> str:\n    \"\"\"Convert Markdown to Confluence-compatible HTML.\"\"\"\n    return markdown.markdown(\n        md_content, extensions=[\"tables\", \"extra\", \"fenced_code\", \"codehilite\"]\n    )\n\n\ndef publish_to_confluence(html_content: str, title: str) -> requests.Response:\n    \"\"\"Create a new page in Confluence.\"\"\"\n    payload = {\n        \"type\": \"page\",\n        \"title\": title,\n        \"space\": {\"key\": CONFIG[\"confluence_space_key\"]},\n        \"body\": {\n            \"storage\": {\n                \"value\": html_content,\n                \"representation\": \"storage\",\n            }\n        },\n    }\n    auth = (CONFIG[\"confluence_user\"], CONFIG[\"confluence_key\"])\n    response = requests.post(\n        CONFIG[\"confluence_url\"],\n        json=payload,\n        auth=auth,\n        headers={\"Content-Type\": \"application/json\"},\n        timeout=30,\n    )\n    return response\n\n\n# ---------------------------------------------------------------------------\n# Main\n# ---------------------------------------------------------------------------\n\ndef main():\n    job_id = CONFIG[\"job_id\"]\n\n    # Step 1: Fetch job definition\n    log.info(\"1. Fetching job definition from Rundeck...\")\n    job_definition = get_job_definition(job_id)\n    project_name, project_url = get_project_info(job_id)\n    log.info(f\"   Project: {project_name} | Job: {job_definition[0].get('name', '?')}\")\n\n    # Step 2: Generate documentation via LLM\n    log.info(\"2. Generating documentation via OpenAI...\")\n    raw_docs = generate_documentation(job_definition, CONFIG[\"openai_model\"])\n    docs = clean_markdown(raw_docs)\n    log.info(f\"   Generated {len(docs)} characters of documentation.\")\n\n    # Step 3: Update job description in Rundeck\n    log.info(\"3. Updating job definition in Rundeck...\")\n    modified_definition = apply_docs_to_job(job_definition, docs)\n    update_job_definition(modified_definition, project_name)\n\n    # Step 4: Optionally publish to Confluence\n    if CONFIG[\"confluence_enabled\"].lower() == \"yes\":\n        log.info(\"4. Publishing to Confluence...\")\n        prefix = build_confluence_prefix(project_name, job_definition, job_id)\n        html = convert_markdown_to_html(prefix + docs)\n        response = publish_to_confluence(html, job_definition[0][\"name\"])\n        if response.status_code == 200:\n            log.info(\"   Confluence page created successfully.\")\n        else:\n            log.error(\n                f\"   Confluence publish failed: {response.status_code} - {response.text}\"\n            )\n    else:\n        log.info(\"4. Confluence publishing skipped (not enabled).\")\n\n    log.info(\"Done.\")\n\n\nif __name__ == \"__main__\":\n    try:\n        main()\n    except requests.exceptions.HTTPError as e:\n        log.error(f\"HTTP error: {e}\")\n        log.error(f\"Response body: {e.response.text if e.response else 'N/A'}\")\n        sys.exit(1)\n    except Exception as e:\n        log.error(f\"Unexpected error: {e}\", exc_info=True)\n        sys.exit(1)",
      "scriptInterpreter" : "python3"
    } ],
    "keepgoing" : false,
    "strategy" : "node-first"
  },
  "uuid" : "f6975c35-c075-4098-94c1-9c692b4698cb"
} ]
